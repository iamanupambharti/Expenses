<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExpenseTracker.</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { background-color: #f3f4f6; font-family: sans-serif; user-select: none; }
        .excel-grid { border-collapse: collapse; width: 100%; }
        .excel-grid th, .excel-grid td { border: 1px solid #e5e7eb; padding: 8px 12px; text-align: left; }
        .excel-grid th { background-color: #f9fafb; font-weight: 600; color: #374151; }
        .excel-grid tr:hover { background-color: #f0fdf4; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .sparkle-btn { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); }
        .animate-fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .listening-pulse { animation: pulse-red 1.5s infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

<script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const ExpenseTracker = () => {
            const [expenses, setExpenses] = useState(() => {
                const saved = localStorage.getItem('my_excel_expenses');
                return saved ? JSON.parse(saved) : [];
            });
            const [locations, setLocations] = useState(() => {
                const saved = localStorage.getItem('my_expense_locations');
                return saved ? JSON.parse(saved) : ['Home', 'Office', 'Online', 'Travel'];
            });
            
            const [formData, setFormData] = useState({ name: '', amount: '', date: new Date().toISOString().split('T')[0], location: 'Home' });
            const [currencySymbol, setCurrencySymbol] = useState('$');
            const [isWidgetMode, setIsWidgetMode] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [notification, setNotification] = useState(null);

            const [showSmartAdd, setShowSmartAdd] = useState(false);
            const [smartInput, setSmartInput] = useState("");

            useEffect(() => { localStorage.setItem('my_excel_expenses', JSON.stringify(expenses)); }, [expenses]);
            useEffect(() => { localStorage.setItem('my_expense_locations', JSON.stringify(locations)); }, [locations]);
            useEffect(() => { lucide.createIcons(); }, [expenses, isWidgetMode, showSettings, showSmartAdd]);

            const showNotify = (msg) => { setNotification(msg); setTimeout(() => setNotification(null), 3000); };
            const formatAmount = (amt) => (parseFloat(amt) || 0).toFixed(2);
            const totalAmount = useMemo(() => expenses.reduce((sum, e) => sum + (Number(e.amount) || 0), 0), [expenses]);
            const sortedExpenses = useMemo(() => [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date)), [expenses]);

            const addExpense = (e) => {
                e.preventDefault();
                if (!formData.name.trim() || !formData.amount) return showNotify("⚠️ Please fill in Name and Amount");
                setExpenses(prev => [...prev, { id: Date.now(), ...formData, amount: parseFloat(formData.amount) }]);
                setFormData(prev => ({ ...prev, name: '', amount: '' }));
                showNotify("✅ Added successfully!");
            };

            const deleteExpense = (id) => setExpenses(prev => prev.filter(e => e.id !== id));
            
            const downloadExcel = () => {
                if (!expenses.length) return showNotify("⚠️ No data!");
                const ws = XLSX.utils.json_to_sheet(expenses.map(e => ({ Date: e.date, Location: e.location, Name: e.name, Amount: e.amount })));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Expenses");
                XLSX.writeFile(wb, "Expense_Sheet.xlsx");
            };

            if (isWidgetMode) return <div className="p-10 text-center">Widget Mode Active (Press Refresh to reset for dev)</div>;

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-5xl mx-auto">
                    <div className="bg-white rounded-xl shadow-xl overflow-hidden border border-gray-100">
                        <div className="bg-green-600 p-6 text-white flex justify-between items-center">
                            <h1 className="text-2xl font-bold flex gap-2 items-center"><i data-lucide="sheet"></i> Expense Tracker</h1>
                            <div className="text-right hidden md:block">
                                <p className="text-xs text-green-100 uppercase font-semibold">Total Spent</p>
                                <p className="text-2xl font-bold">{currencySymbol}{formatAmount(totalAmount)}</p>
                            </div>
                        </div>

                        <div className="p-6 bg-gray-50 border-b border-gray-200">
                            <div className="flex gap-6 mb-6 border-b border-gray-200">
                                <button onClick={() => setShowSmartAdd(false)} className={`text-sm font-bold pb-3 px-1 border-b-2 transition-all ${!showSmartAdd ? 'text-green-600 border-green-600' : 'text-gray-400 border-transparent'}`}>Manual Entry</button>
                                <button onClick={() => setShowSmartAdd(true)} className={`text-sm font-bold pb-3 px-1 border-b-2 transition-all flex items-center gap-2 ${showSmartAdd ? 'text-purple-600 border-purple-600' : 'text-gray-400 border-transparent'}`}><i data-lucide="wand-2" className="w-4 h-4"></i> Smart Add</button>
                            </div>

                            {showSmartAdd ? (
                                <div className="animate-fade-in relative">
                                    <textarea 
                                        value={smartInput}
                                        onChange={(e) => setSmartInput(e.target.value)}
                                        placeholder="Type naturally: 'Lunch at McDonald's for 12 dollars today'..."
                                        className="w-full p-4 border border-purple-200 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none min-h-[120px] text-gray-700 text-lg resize-none shadow-sm"
                                    />
                                    <div className="mt-3 flex justify-end">
                                        <button className="bg-purple-600 text-white px-6 py-2 rounded-lg font-bold shadow-md hover:bg-purple-700 flex gap-2 items-center">
                                            <i data-lucide="wand-2" className="w-4 h-4"></i> Extract & Add
                                        </button>
                                    </div>
                                </div>
                            ) : (
                                <form onSubmit={addExpense} className="flex flex-col md:flex-row gap-4 items-end animate-fade-in">
                                    <input type="date" className="p-3 border rounded-lg" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} />
                                    <select className="p-3 border rounded-lg bg-white" value={formData.location} onChange={e => setFormData({...formData, location: e.target.value})}>{locations.map(l => <option key={l} value={l}>{l}</option>)}</select>
                                    <input type="text" placeholder="Expense Name" className="p-3 border rounded-lg flex-1" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
                                    <input type="number" placeholder="0.00" className="p-3 border rounded-lg w-32" value={formData.amount} onChange={e => setFormData({...formData, amount: e.target.value})} />
                                    <button className="bg-green-600 text-white px-8 py-3 rounded-lg font-bold">Add</button>
                                </form>
                            )}
                        </div>

                        <div className="p-6">
                            <table className="excel-grid w-full">
                                <thead><tr><th>Date</th><th>Location</th><th>Name</th><th className="text-right">Amount</th><th>Action</th></tr></thead>
                                <tbody>
                                    {sortedExpenses.map(e => (
                                        <tr key={e.id}>
                                            <td>{e.date}</td><td>{e.location}</td><td>{e.name}</td>
                                            <td className="text-right">{currencySymbol}{formatAmount(e.amount)}</td>
                                            <td className="text-center"><button onClick={() => deleteExpense(e.id)}><i data-lucide="trash-2" className="w-4 h-4 text-gray-400"></i></button></td>
                                        </tr>
                                    ))}
                                    {expenses.length === 0 && <tr><td colSpan="5" className="text-center py-10 text-gray-400">No data</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ExpenseTracker />);
    </script>
</body>
</html>