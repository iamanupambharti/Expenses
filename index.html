<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExpenseTracker.</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { background-color: #f3f4f6; font-family: sans-serif; user-select: none; }
        .excel-grid { border-collapse: collapse; width: 100%; }
        .excel-grid th, .excel-grid td { border: 1px solid #e5e7eb; padding: 8px 12px; text-align: left; }
        .excel-grid th { background-color: #f9fafb; font-weight: 600; color: #374151; }
        .excel-grid tr:hover { background-color: #f0fdf4; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .sparkle-btn { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); }
        .animate-fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .listening-pulse { animation: pulse-red 1.5s infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

   <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const ExpenseTracker = () => {
            const [expenses, setExpenses] = useState(() => {
                const saved = localStorage.getItem('my_excel_expenses');
                return saved ? JSON.parse(saved) : [];
            });
            const [locations, setLocations] = useState(() => {
                const saved = localStorage.getItem('my_expense_locations');
                return saved ? JSON.parse(saved) : ['Home', 'Office', 'Online', 'Travel'];
            });
            
            const [formData, setFormData] = useState({ name: '', amount: '', date: new Date().toISOString().split('T')[0], location: 'Home' });
            const [currencySymbol, setCurrencySymbol] = useState('$');
            const [isWidgetMode, setIsWidgetMode] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [notification, setNotification] = useState(null);

            useEffect(() => { localStorage.setItem('my_excel_expenses', JSON.stringify(expenses)); }, [expenses]);
            useEffect(() => { localStorage.setItem('my_expense_locations', JSON.stringify(locations)); }, [locations]);
            useEffect(() => { lucide.createIcons(); }, [expenses, isWidgetMode, showSettings]); // Re-run icons on render

            const totalAmount = useMemo(() => expenses.reduce((sum, e) => sum + (Number(e.amount) || 0), 0), [expenses]);
            const sortedExpenses = useMemo(() => [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date)), [expenses]);

            const showNotify = (msg) => { 
                setNotification(msg); 
                setTimeout(() => setNotification(null), 3000); 
            };
            
            const formatAmount = (amt) => (parseFloat(amt) || 0).toFixed(2);

            const addExpense = (e) => {
                e.preventDefault();
                if (!formData.name.trim() || !formData.amount) return showNotify("‚ö†Ô∏è Please fill in Name and Amount");
                
                setExpenses(prev => [...prev, { id: Date.now(), ...formData, amount: parseFloat(formData.amount) }]);
                setFormData(prev => ({ ...prev, name: '', amount: '' })); 
                showNotify("‚úÖ Added successfully!");
            };

            const deleteExpense = (id) => {
                setExpenses(prev => prev.filter(e => e.id !== id));
                showNotify("üóëÔ∏è Expense deleted");
            };

            const downloadExcel = () => {
                if (!expenses.length) return showNotify("‚ö†Ô∏è No data to export!");
                try {
                    const ws = XLSX.utils.json_to_sheet(expenses.map(e => ({ 
                        Date: e.date, Location: e.location, Name: e.name, Amount: e.amount 
                    })));
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Expenses");
                    XLSX.writeFile(wb, "Expense_Sheet.xlsx");
                    showNotify("üì• Excel Downloaded!");
                } catch (e) {
                    console.error(e);
                    showNotify("‚ùå Export failed.");
                }
            };

            if (isWidgetMode) return (
                <div className="h-screen w-screen bg-white p-4 flex flex-col animate-fade-in">
                    <div className="flex justify-between items-start mb-4">
                        <div>
                            <p className="text-xs text-gray-500 font-bold uppercase tracking-wider">Total Spent</p>
                            <p className="text-3xl font-bold text-green-600">{currencySymbol}{formatAmount(totalAmount)}</p>
                        </div>
                        <button onClick={() => setIsWidgetMode(false)} className="p-2 hover:bg-gray-100 rounded-full text-gray-500"><i data-lucide="maximize-2"></i></button>
                    </div>
                    
                    <form onSubmit={addExpense} className="flex flex-col gap-3">
                        <input className="border p-3 rounded-lg bg-gray-50 outline-none focus:ring-2 focus:ring-green-500" placeholder="Expense Name" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
                        <div className="flex gap-2">
                            <select className="border p-3 rounded-lg w-1/3 bg-white text-sm" value={formData.location} onChange={e => setFormData({...formData, location: e.target.value})}>
                                {locations.map(l => <option key={l} value={l}>{l}</option>)}
                            </select>
                            <input className="border p-3 rounded-lg w-1/3 text-sm" type="number" placeholder="0.00" value={formData.amount} onChange={e => setFormData({...formData, amount: e.target.value})} />
                            <button className="bg-green-600 text-white rounded-lg flex-1 hover:bg-green-700"><i data-lucide="plus"></i></button>
                        </div>
                    </form>
                    {notification && (
                        <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gray-900/90 text-white px-4 py-2 rounded-lg text-sm shadow-xl backdrop-blur-sm animate-fade-in">
                            {notification}
                        </div>
                    )}
                </div>
            );

            const SettingsModal = () => (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl w-full max-w-sm p-6 shadow-2xl animate-fade-in">
                        <div className="flex justify-between mb-4">
                            <h2 className="font-bold text-lg">Settings</h2>
                            <button onClick={() => setShowSettings(false)}><i data-lucide="x"></i></button>
                        </div>
                        <h3 className="text-xs font-bold text-gray-500 uppercase mb-2">Currency</h3>
                        <div className="flex gap-2 mb-4">
                            {['$', '‚Ç¨', '¬£', '‚Çπ', '¬•'].map(s => (
                                <button key={s} onClick={() => setCurrencySymbol(s)} className={`w-8 h-8 rounded border ${currencySymbol === s ? 'bg-green-600 text-white' : 'bg-white'}`}>{s}</button>
                            ))}
                        </div>
                        <p className="text-xs text-gray-400">More settings coming in Stage 5...</p>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-5xl mx-auto">
                    {showSettings && <SettingsModal />}
                    
                    <div className="bg-white rounded-xl shadow-xl overflow-hidden border border-gray-100">
                        <div className="bg-green-600 p-6 text-white flex justify-between items-center">
                            <h1 className="text-2xl font-bold flex gap-2 items-center"><i data-lucide="sheet"></i> Expense Tracker</h1>
                            <div className="flex items-center gap-3">
                                <div className="text-right hidden md:block mr-2">
                                    <p className="text-xs text-green-100 uppercase font-semibold">Total Spent</p>
                                    <p className="text-2xl font-bold">{currencySymbol}{formatAmount(totalAmount)}</p>
                                </div>
                                <button onClick={() => setShowSettings(true)} className="bg-green-700/50 hover:bg-green-700 p-2 rounded-lg transition-colors" title="Settings"><i data-lucide="settings"></i></button>
                                <button onClick={() => setIsWidgetMode(true)} className="bg-green-700/50 hover:bg-green-700 p-2 rounded-lg transition-colors" title="Widget Mode"><i data-lucide="minimize-2"></i></button>
                            </div>
                        </div>

                        <div className="p-6 bg-gray-50 border-b border-gray-200">
                            <form onSubmit={addExpense} className="flex flex-col md:flex-row gap-4 items-end">
                                <div className="w-full md:w-40">
                                    <label className="text-xs font-bold text-gray-500 uppercase ml-1">Date</label>
                                    <input type="date" className="p-3 border rounded-lg w-full" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} />
                                </div>
                                <div className="w-full md:w-48">
                                    <label className="text-xs font-bold text-gray-500 uppercase ml-1">Location</label>
                                    <select className="p-3 border rounded-lg w-full bg-white" value={formData.location} onChange={e => setFormData({...formData, location: e.target.value})}>
                                        {locations.map(l => <option key={l} value={l}>{l}</option>)}
                                    </select>
                                </div>
                                <div className="flex-1 w-full">
                                    <label className="text-xs font-bold text-gray-500 uppercase ml-1">Name</label>
                                    <input type="text" placeholder="Expense Name" className="p-3 border rounded-lg w-full" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
                                </div>
                                <div className="w-full md:w-32">
                                    <label className="text-xs font-bold text-gray-500 uppercase ml-1">Amount</label>
                                    <input type="number" step="0.01" placeholder="0.00" className="p-3 border rounded-lg w-full font-mono" value={formData.amount} onChange={e => setFormData({...formData, amount: e.target.value})} />
                                </div>
                                <button className="bg-green-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-green-700 shadow-md flex gap-2 items-center justify-center">
                                    <i data-lucide="plus-circle"></i> Add
                                </button>
                            </form>
                        </div>

                        <div className="p-6">
                            <div className="overflow-x-auto rounded-lg border border-gray-200 shadow-sm max-h-[500px] overflow-y-auto">
                                <table className="excel-grid w-full">
                                    <thead className="sticky top-0 shadow-sm z-10">
                                        <tr>
                                            <th>Date</th>
                                            <th>Location</th>
                                            <th>Name</th>
                                            <th className="text-right">Amount</th>
                                            <th className="text-center">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white">
                                        {sortedExpenses.map(e => (
                                            <tr key={e.id} className="group hover:bg-green-50">
                                                <td className="font-mono text-sm text-gray-600">{e.date}</td>
                                                <td><span className="bg-gray-100 px-2 py-1 rounded text-xs border">{e.location}</span></td>
                                                <td className="font-medium">{e.name}</td>
                                                <td className="text-right font-mono font-bold">{currencySymbol}{formatAmount(e.amount)}</td>
                                                <td className="text-center">
                                                    <button onClick={() => deleteExpense(e.id)} className="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" className="w-4 h-4"></i></button>
                                                </td>
                                            </tr>
                                        ))}
                                        {expenses.length === 0 && <tr><td colSpan="5" className="text-center py-10 text-gray-400 italic">No expenses yet.</td></tr>}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div className="mt-6 pt-4 border-t flex justify-between items-center text-sm text-gray-500">
                                <span>{expenses.length} records</span>
                                <button onClick={downloadExcel} className="border-2 border-green-600 text-green-700 font-bold py-2 px-6 rounded-lg hover:bg-green-50 flex gap-2 items-center">
                                    <i data-lucide="download" className="w-4 h-4"></i> Export to Excel
                                </button>
                            </div>
                        </div>
                    </div>

                    {notification && (
                        <div className="fixed bottom-6 right-6 bg-gray-900 text-white px-6 py-3 rounded-lg shadow-2xl animate-bounce z-[60] flex items-center gap-3">
                            <i data-lucide="bell" className="w-4 h-4 text-green-400"></i> {notification}
                        </div>
                    )}
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ExpenseTracker />);
    </script>
</body>
</html>