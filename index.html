<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExpenseTracker.</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { background-color: #f3f4f6; font-family: sans-serif; user-select: none; }
        .excel-grid { border-collapse: collapse; width: 100%; }
        .excel-grid th, .excel-grid td { border: 1px solid #e5e7eb; padding: 8px 12px; text-align: left; }
        .excel-grid th { background-color: #f9fafb; font-weight: 600; color: #374151; }
        .excel-grid tr:hover { background-color: #f0fdf4; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .sparkle-btn { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); }
        .animate-fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .listening-pulse { animation: pulse-red 1.5s infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

<script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const ExpenseTracker = () => {
            const [expenses, setExpenses] = useState(() => {
                const saved = localStorage.getItem('my_excel_expenses');
                return saved ? JSON.parse(saved) : [];
            });
            const [locations, setLocations] = useState(() => {
                const saved = localStorage.getItem('my_expense_locations');
                return saved ? JSON.parse(saved) : ['Home', 'Office', 'Online', 'Travel'];
            });
            
            const [history, setHistory] = useState([]); 
            const [searchTerm, setSearchTerm] = useState(""); 
            const [newLocationInput, setNewLocationInput] = useState("");

            const [formData, setFormData] = useState({ name: '', amount: '', date: new Date().toISOString().split('T')[0], location: 'Home' });
            const [currencySymbol, setCurrencySymbol] = useState('$');
            const [isWidgetMode, setIsWidgetMode] = useState(false);
            const [notification, setNotification] = useState(null);

            const [showSmartAdd, setShowSmartAdd] = useState(false);
            const [smartInput, setSmartInput] = useState("");
            const [isListening, setIsListening] = useState(false);
            const recognitionRef = useRef(null);
            const fileInputRef = useRef(null);

            const [showSettings, setShowSettings] = useState(false);
            const [showAnalysis, setShowAnalysis] = useState(false);
            const [userApiKey, setUserApiKey] = useState("");
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [analysisResult, setAnalysisResult] = useState("");

            useEffect(() => { 
                localStorage.setItem('my_excel_expenses', JSON.stringify(expenses)); 
                localStorage.setItem('my_expense_locations', JSON.stringify(locations));
                localStorage.setItem('my_expense_currency', currencySymbol);
                localStorage.setItem('my_gemini_api_key', userApiKey);
            }, [expenses, locations, currencySymbol, userApiKey]);

            useEffect(() => {
                const savedKey = localStorage.getItem('my_gemini_api_key');
                if (savedKey) setUserApiKey(savedKey);
                const savedCurr = localStorage.getItem('my_expense_currency');
                if (savedCurr) setCurrencySymbol(savedCurr);
                lucide.createIcons();
            }, [expenses, showSmartAdd, showSettings, showAnalysis, isWidgetMode, searchTerm, locations]);

            const filteredExpenses = useMemo(() => {
                return expenses.filter(e => 
                    e.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                    e.location.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    e.date.includes(searchTerm)
                );
            }, [expenses, searchTerm]);

            const sortedExpenses = useMemo(() => [...filteredExpenses].sort((a, b) => new Date(b.date) - new Date(a.date)), [filteredExpenses]);
            const totalAmount = useMemo(() => expenses.reduce((sum, e) => sum + (Number(e.amount) || 0), 0), [expenses]);
            
            const showNotify = (msg) => { setNotification(msg); setTimeout(() => setNotification(null), 3000); };
            const formatAmount = (amt) => (parseFloat(amt) || 0).toFixed(2);

            const addLocation = (e) => {
                e.preventDefault();
                const val = newLocationInput.trim();
                if (!val) return;
                if (locations.some(l => l.toLowerCase() === val.toLowerCase())) return showNotify("âš ï¸ Location already exists");
                
                setLocations(prev => [...prev, val]);
                setNewLocationInput("");
            };

            const removeLocation = (loc) => {
                if (locations.length <= 1) return showNotify("âš ï¸ Keep at least one location");
                setLocations(prev => prev.filter(l => l !== loc));
                if (formData.location === loc) setFormData(prev => ({ ...prev, location: locations.find(l => l !== loc) || "" }));
            };

            const saveToHistory = () => { setHistory(prev => [...prev.slice(-10), [...expenses]]); };
            const handleUndo = () => {
                if (history.length === 0) return;
                setExpenses(history[history.length - 1]);
                setHistory(prev => prev.slice(0, -1));
                showNotify("â†©ï¸ Reverted Last Action");
            };

            const handleImportClick = () => fileInputRef.current.click();
            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                saveToHistory();
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const bstr = evt.target.result;
                        const wb = XLSX.read(bstr, { type: 'binary' });
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const data = XLSX.utils.sheet_to_json(ws);
                        const newExpenses = data.map(row => ({
                            id: Date.now() + Math.random(),
                            date: row.Date || new Date().toISOString().split('T')[0],
                            location: row.Location || "Imported",
                            name: row.Name || row["Expense Name"] || "Unknown Import",
                            amount: parseFloat(row.Amount) || 0
                        })).filter(e => e.amount > 0);
                        setExpenses(prev => [...prev, ...newExpenses]);
                        showNotify(`ðŸ“¥ Imported ${newExpenses.length} records!`);
                    } catch (err) { console.error(err); showNotify("âŒ Failed to parse Excel file"); }
                };
                reader.readAsBinaryString(file);
                e.target.value = null;
            };

            const callGemini = async (prompt) => {
                if (!userApiKey) { setShowSettings(true); showNotify("âš ï¸ Set API Key in Settings first!"); return null; }
                if (!navigator.onLine) { showNotify("âš ï¸ No Internet Connection"); return null; }
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userApiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    if (!response.ok) throw new Error("API Request Failed");
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Error";
                } catch (e) { showNotify("AI Service Unavailable. Check Key."); return "Error"; }
            };

            const handleSmartAdd = async () => {
                if (!smartInput.trim()) return;
                saveToHistory();
                setIsAiLoading(true);
                const prompt = `Extract structured expense data from: "${smartInput}". Date: ${new Date().toISOString().split('T')[0]}. Locations: ${locations.join(', ')}. Currency: ${currencySymbol}. Return raw JSON: name, amount, date, location.`;
                const result = await callGemini(prompt);
                if (result && result !== "Error") {
                    try {
                        const jsonStart = result.indexOf('{'); const jsonEnd = result.lastIndexOf('}');
                        if (jsonStart !== -1) {
                            const data = JSON.parse(result.substring(jsonStart, jsonEnd + 1));
                            if (data.amount) {
                                if (data.location && !locations.includes(data.location)) setLocations(prev => [...prev, data.location]);
                                setExpenses(prev => [...prev, { id: Date.now(), name: data.name || "Unknown", amount: parseFloat(data.amount), date: data.date, location: data.location || "Home" }]);
                                setSmartInput(""); showNotify("âœ¨ AI Added!");
                            } else showNotify("Could not understand amount.");
                        }
                    } catch (e) { showNotify("Failed to parse AI response."); }
                }
                setIsAiLoading(false);
            };

            const handleAnalyze = async () => {
                if (!expenses.length) return showNotify("No data to analyze!");
                setShowAnalysis(true); setAnalysisResult(""); setIsAiLoading(true);
                const recent = expenses.slice(-50).map(e => ({n:e.name, a:e.amount, l:e.location}));
                const result = await callGemini(`Analyze these expenses (${currencySymbol}): ${JSON.stringify(recent)}. Provide summary, categories, and 1 tip. Use emojis. Markdown format.`);
                setAnalysisResult(result || "Analysis failed."); setIsAiLoading(false);
            };

            const addExpense = (e) => {
                e.preventDefault();
                saveToHistory();
                setExpenses(prev => [...prev, { id: Date.now(), ...formData, amount: parseFloat(formData.amount) }]);
                showNotify("Added!");
            };

            const deleteExpense = (id) => {
                saveToHistory();
                setExpenses(prev => prev.filter(e => e.id !== id));
                showNotify("ðŸ—‘ï¸ Deleted");
            };

            const downloadExcel = () => {
                const ws = XLSX.utils.json_to_sheet(expenses.map(e => ({ Date: e.date, Location: e.location, Name: e.name, Amount: e.amount })));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Expenses");
                XLSX.writeFile(wb, "Expense_Sheet.xlsx");
            };

            const handleVoiceInput = () => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) return showNotify("Voice not supported");
                if (isListening) { if (recognitionRef.current) recognitionRef.current.stop(); setIsListening(false); return; }
                const recognition = new SpeechRecognition(); recognitionRef.current = recognition; recognition.lang = 'en-US';
                recognition.onstart = () => { setIsListening(true); showNotify("ðŸŽ™ï¸ Listening..."); };
                recognition.onend = () => setIsListening(false);
                recognition.onresult = (e) => setSmartInput(prev => (prev ? prev + " " : "") + e.results[0][0].transcript);
                recognition.start();
            };

            if (isWidgetMode) return (
                <div className="h-screen w-screen bg-white p-4 flex flex-col animate-fade-in">
                    <div className="flex justify-between items-start mb-4">
                        <div><p className="text-xs text-gray-500 font-bold uppercase">Total</p><p className="text-3xl font-bold text-green-600">{currencySymbol}{formatAmount(totalAmount)}</p></div>
                        <button onClick={() => setIsWidgetMode(false)} className="p-2 bg-gray-100 rounded-full"><i data-lucide="maximize-2"></i></button>
                    </div>
                    <form onSubmit={addExpense} className="flex flex-col gap-3">
                        <input className="border p-3 rounded-lg bg-gray-50" placeholder="Name" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
                        <div className="flex gap-2">
                            <select className="border p-3 rounded-lg w-1/3 bg-white text-sm" value={formData.location} onChange={e => setFormData({...formData, location: e.target.value})}>
                                {locations.map(l => <option key={l} value={l}>{l}</option>)}
                            </select>
                            <input className="border p-3 rounded-lg w-1/3" type="number" placeholder="0.00" value={formData.amount} onChange={e => setFormData({...formData, amount: e.target.value})} />
                            <button className="bg-green-600 text-white rounded-lg flex-1"><i data-lucide="plus"></i></button>
                        </div>
                    </form>
                </div>
            );

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-5xl mx-auto">
                    {showSettings && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl w-full max-w-md p-6 shadow-2xl animate-fade-in">
                                <div className="flex justify-between mb-4"><h2 className="font-bold text-xl flex items-center gap-2"><i data-lucide="settings"></i> Settings</h2><button onClick={() => setShowSettings(false)} className="hover:bg-gray-100 p-1 rounded"><i data-lucide="x"></i></button></div>
                                <div className="space-y-6">
                                    <div><label className="text-xs font-bold text-gray-500 uppercase">Gemini API Key</label><input type="password" value={userApiKey} onChange={e => setUserApiKey(e.target.value)} placeholder="Paste Key..." className="w-full border p-2 rounded mt-1" /></div>
                                    <div>
                                        <label className="text-xs font-bold text-gray-500 uppercase block mb-2">Currency</label>
                                        <div className="flex gap-2">{['$', 'â‚¬', 'Â£', 'â‚¹', 'Â¥'].map(s => <button key={s} onClick={() => setCurrencySymbol(s)} className={`w-8 h-8 rounded border font-bold ${currencySymbol === s ? 'bg-green-600 text-white' : 'bg-white text-gray-600'}`}>{s}</button>)}</div>
                                    </div>
                                    
                                    <div>
                                        <label className="text-xs font-bold text-gray-500 uppercase block mb-2">Locations</label>
                                        <div className="flex flex-wrap gap-2 mb-3">
                                            {locations.map(l => (
                                                <span key={l} className="bg-blue-50 text-blue-700 border border-blue-100 px-2 py-1 rounded-md text-sm flex gap-1 items-center">
                                                    {l} 
                                                    <button onClick={() => removeLocation(l)} className="hover:text-red-500 ml-1"><i data-lucide="x" className="w-3 h-3"></i></button>
                                                </span>
                                            ))}
                                        </div>
                                        <form onSubmit={addLocation} className="flex gap-2">
                                            <input value={newLocationInput} onChange={e => setNewLocationInput(e.target.value)} placeholder="Add new location..." className="border p-2 flex-1 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" />
                                            <button className="bg-blue-600 text-white px-4 rounded text-sm hover:bg-blue-700 font-medium">Add</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    {showAnalysis && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto shadow-2xl animate-fade-in">
                                <div className="flex justify-between mb-4 sticky top-0 bg-white pb-2 border-b"><h2 className="font-bold flex gap-2"><i data-lucide="sparkles" className="text-purple-600"></i> Insights</h2><button onClick={() => setShowAnalysis(false)}><i data-lucide="x"></i></button></div>
                                {isAiLoading ? <div className="text-center py-10 text-purple-600 animate-pulse">Analyzing...</div> : <div className="prose text-sm" dangerouslySetInnerHTML={{ __html: marked.parse(analysisResult) }}></div>}
                            </div>
                        </div>
                    )}

                    <div className="bg-white rounded-xl shadow-xl overflow-hidden border border-gray-100">
                        <div className="bg-green-600 p-6 text-white flex justify-between items-center">
                            <h1 className="text-2xl font-bold flex gap-2 items-center"><i data-lucide="sheet"></i> Expense Tracker</h1>
                            <div className="flex items-center gap-3">
                                <div className="text-right hidden md:block mr-2"><p className="text-xs text-green-100 uppercase font-semibold">Total Spent</p><p className="text-2xl font-bold">{currencySymbol}{formatAmount(totalAmount)}</p></div>
                                <button onClick={handleAnalyze} className="sparkle-btn px-4 py-2 rounded-lg text-white flex gap-2 items-center shadow-lg font-medium text-sm"><i data-lucide="sparkles" className="w-4 h-4"></i> <span className="hidden sm:inline">Insights</span></button>
                                <button onClick={() => setShowSettings(true)} className="bg-green-700/50 p-2 rounded-lg hover:bg-green-700 transition-colors"><i data-lucide="settings" className="w-5 h-5"></i></button>
                                <button onClick={() => setIsWidgetMode(true)} className="bg-green-700/50 p-2 rounded-lg hover:bg-green-700 transition-colors"><i data-lucide="minimize-2" className="w-5 h-5"></i></button>
                            </div>
                        </div>

                        <div className="p-6 bg-gray-50 border-b border-gray-200">
                            <div className="flex gap-6 mb-6 border-b border-gray-200">
                                <button onClick={() => setShowSmartAdd(false)} className={`text-sm font-bold pb-3 px-1 border-b-2 ${!showSmartAdd ? 'text-green-600 border-green-600' : 'text-gray-400 border-transparent'}`}>Manual Entry</button>
                                <button onClick={() => setShowSmartAdd(true)} className={`text-sm font-bold pb-3 px-1 border-b-2 flex items-center gap-2 ${showSmartAdd ? 'text-purple-600 border-purple-600' : 'text-gray-400 border-transparent'}`}><i data-lucide="wand-2" className="w-4 h-4"></i> Smart Add</button>
                            </div>

                            {showSmartAdd ? (
                                <div className="animate-fade-in relative">
                                    <textarea value={smartInput} onChange={(e) => setSmartInput(e.target.value)} placeholder="Type or speak: 'Lunch at McDonald's for 12 dollars'..." className="w-full p-4 border border-purple-200 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none min-h-[120px] text-gray-700 pr-14 text-lg" disabled={isAiLoading} />
                                    <button onClick={handleVoiceInput} disabled={isAiLoading} className={`absolute top-3 right-3 p-2 rounded-full transition-all ${isListening ? 'bg-red-500 text-white listening-pulse' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}><i data-lucide={isListening ? "mic-off" : "mic"} className="w-5 h-5"></i></button>
                                    <div className="mt-3 flex justify-between items-center">
                                        <p className="text-xs text-gray-500 italic">{isListening ? "Recording..." : "AI auto-detects: Date, Amount, Name, Location"}</p>
                                        <button onClick={handleSmartAdd} disabled={isAiLoading || !smartInput.trim()} className="sparkle-btn text-white px-6 py-2 rounded-lg font-bold shadow-md hover:shadow-lg transition-all flex items-center gap-2 disabled:opacity-50">{isAiLoading ? "Processing..." : <><i data-lucide="wand-2" className="w-4 h-4"></i> Extract & Add</>}</button>
                                    </div>
                                </div>
                            ) : (
                                <form onSubmit={addExpense} className="flex flex-col md:flex-row gap-4 items-end animate-fade-in">
                                    <input type="date" className="p-3 border rounded-lg" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} />
                                    <select className="p-3 border rounded-lg bg-white" value={formData.location} onChange={e => setFormData({...formData, location: e.target.value})}>{locations.map(l => <option key={l} value={l}>{l}</option>)}</select>
                                    <input type="text" placeholder="Expense Name" className="p-3 border rounded-lg flex-1" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
                                    <input type="number" placeholder="0.00" className="p-3 border rounded-lg w-32" value={formData.amount} onChange={e => setFormData({...formData, amount: e.target.value})} />
                                    <button className="bg-green-600 text-white px-8 py-3 rounded-lg font-bold">Add</button>
                                </form>
                            )}
                        </div>

                        <div className="p-6">
                            <div className="flex justify-between items-center mb-4 gap-4 flex-wrap">
                                <div className="relative flex-1 min-w-[200px]">
                                    <i data-lucide="search" className="absolute left-3 top-3 text-gray-400 w-4 h-4"></i>
                                    <input type="text" placeholder="Search expenses..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="pl-10 p-2 border border-gray-300 rounded-lg w-full focus:ring-2 focus:ring-green-500 outline-none" />
                                </div>
                                <div className="flex gap-2">
                                    {history.length > 0 && <button onClick={handleUndo} className="bg-yellow-100 text-yellow-700 px-4 py-2 rounded-lg font-bold hover:bg-yellow-200 flex items-center gap-2"><i data-lucide="undo-2" className="w-4 h-4"></i> Undo</button>}
                                </div>
                            </div>

                            <div className="overflow-x-auto rounded-lg border border-gray-200 shadow-sm max-h-[500px] overflow-y-auto">
                                <table className="excel-grid w-full">
                                    <thead className="sticky top-0 shadow-sm z-10">
                                        <tr><th>Date</th><th>Location</th><th>Name</th><th className="text-right">Amount</th><th>Action</th></tr>
                                    </thead>
                                    <tbody className="bg-white">
                                        {sortedExpenses.map(e => (
                                            <tr key={e.id}>
                                                <td>{e.date}</td><td><span className="bg-gray-100 px-2 py-1 rounded text-xs border text-gray-600">{e.location}</span></td><td>{e.name}</td>
                                                <td className="text-right font-mono font-bold">{currencySymbol}{formatAmount(e.amount)}</td>
                                                <td className="text-center"><button onClick={() => deleteExpense(e.id)}><i data-lucide="trash-2" className="w-4 h-4 text-gray-400 hover:text-red-500"></i></button></td>
                                            </tr>
                                        ))}
                                        {sortedExpenses.length === 0 && <tr><td colSpan="5" className="text-center py-10 text-gray-400 italic">No matching expenses found.</td></tr>}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div className="mt-6 pt-4 border-t flex flex-wrap gap-4 justify-between items-center text-sm text-gray-500">
                                <span>{expenses.length} records</span>
                                <div className="flex gap-2">
                                    <input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" accept=".xlsx, .xls" />
                                    <button onClick={handleImportClick} className="border-2 border-blue-600 text-blue-700 font-bold py-2 px-6 rounded-lg hover:bg-blue-50 flex gap-2 items-center"><i data-lucide="upload" className="w-4 h-4"></i> Import Excel</button>
                                    <button onClick={downloadExcel} className="border-2 border-green-600 text-green-700 font-bold py-2 px-6 rounded-lg hover:bg-green-50 flex gap-2 items-center"><i data-lucide="download" className="w-4 h-4"></i> Export Excel</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {notification && <div className="fixed bottom-6 right-6 bg-gray-900 text-white px-6 py-3 rounded-lg shadow-2xl animate-bounce z-[60] flex items-center gap-3"><i data-lucide="bell" className="w-4 h-4 text-green-400"></i> {notification}</div>}
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ExpenseTracker />);
    </script>

</body>
</html>